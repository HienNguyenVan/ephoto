var hap={options:{id:"#hapPhotos",build_timeout:5E3,max_width:200,container_padding:45,loading_on_scroll:!0,request_url:"",request_params:{},build_min_count:2},is_loading:!1,timer:null,image_sizes:[],success_loaded:0,failed_loaded:0,need_load_count:0,page:1,is_end:0,container_width:0,isDebug:function(){return-1!==window.location.hash.indexOf("#debug")},initialize:function(a){$("#hapBuildLoader").addClass("active");"undefined"!=typeof a.request_url&&(this.options.request_url=a.request_url);"undefined"!=
typeof a.max_width&&(this.options.max_width=a.max_width);"undefined"!=typeof a.id&&(this.options.id=a.id);"undefined"!=typeof a.loading_on_scroll&&(this.options.loading_on_scroll=a.loading_on_scroll);"undefined"!=typeof a.listType&&(this.options.request_params.listType=a.listType);"undefined"!=typeof a.tag&&(this.options.request_params.tag=a.tag);this.e=$(this.options.id);this.e.children().css("visibility","hidden");this.setup();this.bindRebuildOnLoadImages();this.bindRebuildOnTimeout();window[this.options.id]=
this},error:function(a){},setup:function(){var a=this;this.options.loading_on_scroll&&$(window).scroll(function(){clearTimeout(a.timer);setTimeout(function(){$(window).scrollTop()>=$(document).height()-$(window).height()&&a.e.is(":visible")&&a.loadMore()},1E3)})},loadContent:function(a,c,d){var b=this;c||(c={});b.is_loading||(b.is_end=!1,b.page=1,b.image_sizes=[],b.is_loading=!0,$("#hapLoader").addClass("active"),$.ajax({url:b.options.request_url,data:c,dataType:"json",success:function(a){b.e.empty();
b.is_loading=!1;$("#hapLoader").removeClass("active");a.item_count&&(b.e.append(a.body),$(a.body).css("visibility","hidden").addClass("with_effect"),b.addCmpMarkup(a));a.is_next||(b.is_end=!0);b.bindRebuildOnLoadImages();b.bindRebuildOnTimeout();b.setup();d&&d(a)},error:function(){b.error("Request error");b.is_loading=!1;$("#hapLoader").removeClass("active")}}))},loadMore:function(a){var c=this;if(!c.is_loading&&!this.is_end){c.is_loading=!0;$("#hapLoader").addClass("active");c.page++;var d=c.options.request_params;
d.page=c.page;d.format="json";$.ajax({url:c.options.request_url,data:d,dataType:"json",success:function(b){c.is_loading=!1;$("#hapLoader").removeClass("active");b.item_count&&(c.e.append(b.body),$(b.body).css("visibility","hidden").addClass("with_effect"),c.addCmpMarkup(b));b.is_next||(c.is_end=!0);c.bindRebuildOnLoadImages();c.bindRebuildOnTimeout();a&&a(b)},error:function(){c.error("Request error");c.is_loading=!1;$("#hapLoader").removeClass("active")}})}},rebuild:function(){var a=this;$("#hapBuildLoader").addClass("active");
this.container_width=this.e.parent().width()-30;this.e.css("width",this.container_width+this.options.container_padding).css("max-width",this.container_width+this.options.container_padding);this.e.find(".img:not(.size_saved)").each(function(b){b=$(this);var c=b.width(),d=b.height();c&&d&&(b.addClass("size_saved"),a.isDebug()&&(b.css("visibility","hidden"),b.parent().css("border","#000 1px solid").css("background-color","#222")),a.image_sizes[a.image_sizes.length]={width:c,height:d,ratio:c/d,element_id:b.attr("id")})});
var c=0,d=0,b=[];$.each(a.image_sizes,function(k,g){var h=a.options.max_width*g.ratio,e=$("#"+g.element_id);e.css("max-width",h);a.isDebug()&&(e.css("visibility","hidden"),e.parent().css("border","#000 1px solid").css("background-color","#222"));c+=h;c>a.container_width&&(d++,c=0);b[d]||(b[d]=[]);b[d][b[d].length]={img:e,max_width:h}});var f=[];$.each(b,function(a,b){var c=0;$.each(b,function(a,b){c+=b.max_width});f[f.length]=c});a.lines=b;a.lines_width=f;$.each(b,function(b,c){if(c.length<a.options.build_min_count)$.each(c,
function(b,c){c.img.closest("li").addClass("li_line");a.isDebug()&&(c.img.css("visibility","hidden"),c.img.parent().css("border","#000 1px solid").css("background-color","#222"))});else{var d=f[b];$.each(c,function(c,e){var f=e.max_width*(a.container_width/(a.container_width-(a.container_width-d))),g=e.img.closest("li");e.img.css("max-width",f);e.img.addClass("line"+b);g.addClass("li_line"+b).addClass("li_line").css("width",f);a.isDebug()&&(e.img.css("visibility","hidden"),e.img.arent().css("border",
"#000 1px solid").css("background-color","#222"))});var e=a.e.find(".li_line"+b+" img"),e=a.getMax(e);a.e.find(".li_line"+b).css("height",e);a.e.find(".li_line"+b+" .aimg").css("line-height",e);a.e.find(".li_line"+b+" .img").css("line-height",e)}});a.e.children().css("visibility","visible");setTimeout(function(){$("#hapBuildLoader").removeClass("active")},3E3);a.e.children(".with_effect").css("opacity",0).removeClass("with_effect")},getMax:function(a){var c=0;$.each(a,function(a,b){var f=$(b).height();
f>c&&(c=f)});return c},bindRebuildOnTimeout:function(){var a=this;$(document).ready(function(){clearTimeout(a.timeout_timer);a.timeout_timer=setTimeout(function(){a.rebuild()},a.options.build_timeout)});clearTimeout(a.timeout_timer);a.timeout_timer=setTimeout(function(){a.rebuild()},a.options.build_timeout)},bindRebuildOnLoadImages:function(){var a=this,c=this.e.find(".img:not(.photo_onload_binded)");c.addClass("photo_onload_binded");this.need_load_count=c.length;this.failed_loaded=this.success_loaded=
0;c.unbind("load").load(function(){$(this).addClass("photo_loaded");a.success_loaded++;a.checkOnLoadImages()}).unbind("error").error(function(){$(this).addClass("photo_error");a.failed_loaded++;a.need_load_count--})},checkOnLoadImages:function(){this.success_loaded>=this.need_load_count&&this.rebuild()},getInternetExplorerVersion:function(){var a=-1;"Microsoft Internet Explorer"==navigator.appName&&null!=/MSIE ([0-9]{1,}[.0-9]{0,})/.exec(navigator.userAgent)&&(a=parseFloat(RegExp.$1));return a},addCmpMarkup:function(a){a.css&&
OW.addCss(a.css);a.scriptFiles?OW.addScriptFiles(a.scriptFiles,function(){a.onloadScript&&OW.addScript(a.onloadScript)}):a.onloadScript&&OW.addScript(a.onloadScript)}};